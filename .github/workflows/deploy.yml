name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            export DOMAIN="${{ secrets.DOMAIN }}"
            export BREVO_API_KEY="${{ secrets.BREVO_API_KEY }}"
            export SENDGRID_API_KEY="${{ secrets.SENDGRID_API_KEY }}"
            export SESSION_SECRET="${{ secrets.SESSION_SECRET }}"
            export DATABASE_URL="${{ secrets.DATABASE_URL }}"
            export PORT="${{ secrets.PORT }}"
            sudo apt-get update -y
            sudo apt-get install -y nginx
            if ! command -v node >/dev/null 2>&1; then
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
            sudo npm i -g pm2
            sudo mkdir -p /var/www/tradeconnect
            sudo chown $USER:$USER /var/www/tradeconnect
            cd /var/www/tradeconnect
            if [ -d .git ]; then
              git fetch origin main
              git reset --hard origin/main
            else
              git clone https://github.com/${{ github.repository }} .
            fi
            npm ci
            npm run build
            BREVO_API_KEY="$BREVO_API_KEY" SENDGRID_API_KEY="$SENDGRID_API_KEY" SESSION_SECRET="$SESSION_SECRET" DATABASE_URL="$DATABASE_URL" DOMAIN="$DOMAIN" PORT="${PORT:-5000}" pm2 start ecosystem.config.js --env production --name tradeconnect
            pm2 save
            sudo bash -c "cat > /etc/nginx/sites-available/tradeconnect <<CONF
            server {
              listen 80;
              server_name ${DOMAIN};
              location / {
                proxy_pass http://127.0.0.1:${PORT:-5000};
                proxy_http_version 1.1;
                proxy_set_header Upgrade \$http_upgrade;
                proxy_set_header Connection \"upgrade\";
                proxy_set_header Host \$host;
                proxy_set_header X-Real-IP \$remote_addr;
                proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto \$scheme;
              }
            }
            CONF"
            sudo ln -sf /etc/nginx/sites-available/tradeconnect /etc/nginx/sites-enabled/tradeconnect
            sudo nginx -t
            sudo systemctl reload nginx
